# Password Attacks 

Password representations are associated with hash keys such as, 

1. MD5 
2. SHA 
3. WHIRLPOOL 
4. RipeMD 

They are also are defined as a 'One-Way function'. 
The basics of a one-way hash value function is when each input sequence is assigned a hash value, which is what is used in the authorizations tag. So while it's easy to read the input in, the output is far harder to decypt into the original input sequence. They are also collision free, so no, difference sequences with the dame hash value is the lottery ticker of the hash world. 

Not to mention that data that is generated by the hash functions are **psuedorandom**. 

Therefore, for password attacks the most effective method is through *professional guessing.*

### Methods for Cracking Hashes 

1. Lookup Tables
    - Pre-computed hashes from a dictionary get stored with their correspponing password into a lookup table

2. Reverse Lookup tables 
    - Allows for an attacker to brute force or dictionary attack to many hashes at the same time w/o a pre-computed lookup table
    
3. Rainbow Tables
    - A time-memory techinque that make the lookup tables small, but sacrificing the cracking speed as a consequence
    
4. Hashing with Salt
    - Randomizing hashes by appending or prepending a random string 

## Offline Password Attacks 

When a pentester is attempting to recover one or more passwords from a password storage file, it's considered as offline password attacks. 

The files are usually in either, 
1. Security Acount Manager (SAM) on Windows 
2. /etc/shadow on Linux 

Offline password attacks usually  require that the attacker have root and admin privileges. The exception to this being the password hashes being pulled from the database using;

1. SQL Injection 
2. Unprotected flat text files on a web server
3. Other unprotected/badly protected sources

The interface attakers use is the same one the legitimate users use such as login web pages and SSH or FTP servers. 

##### Difference between Offline and Online? 

Online is noisy. It also potentially leaves only one entry per attempt in a log file, thus minimizing the speed and efficiency of attack. 

For Offline attacks, after the credible storage mechanism is recovered there is not a single crumb on the target's system. Get in and Get out. 

### Offline Password Cracking Methods

##### Brute Force Attacks


1. uses all the possible combinations of a password in a given character set, depending of the given size. 
2. Due to the sheer size of the math of the possible combinations, it would take way too long to crack passwords with a brute force attack without specification. think around 210 years. 
3. attacker needs to have background information on the possible password pattern. 
    - basic assumptions include:
            - Password is eight characters long
            - First character is upper case
            - Next five characters are lower case
            - Next character is a number
            - Next character is a symbol
    - these assumptions cut the time to crack a password to 1.2 **days**

##### Dictionary Attack 

Allows attacker to use a list of common passwords and test a password hash against each word in that list. After the word is compared with the hash and it matches to word is most probable to be the original password.

**Resource**
https://crackstation.net/crackstation-wordlist-password-cracking-dictionary.htm

- Has a dictionary of 1.5 billion passwords 

##### Rule Based Attack 

Can apply permutations to the passwords to be guessed. Rules like "alphanumeric and eight characters long." 

##### Hybrid Attack 

Combining a limited Brute Force Attack and a dictionary attack, such as appeding all the combinations of 4 digit numbers to all the words in a dictionary

### hashcat

Keeping with the guess it till you make it theme, every attempt made is hashed and then compared to the actual hashed valued. The hashcat tool uses precomputed dictionaries, rainbow tables, and the brute force approach to find the most efficient way to crack the password. 

Some Features: 

1. It is multi-threaded

2. It is multi-hash and multi-OS based (Linux, Windows and OSX native binaries)

3. It is multi-Algorithm based (MD4, MD5, SHA1, DCC, NTLM, MySQL, etc.)

4. All attack-modes can be extended by specialized rules

5. It is possible to resume or limit sessions automatically. They recognize recovered hashes from the outfile at startup

6. It can load the salt list from the external file. This can be used as a brute-force attack variant

7. The number of threads can be configured and executed based on the lowest priority; 

8. It supports both hex-charset and hex-salt files

9. The 90+ Algorithm can be implemented with performance and optimization in mind.


##### Attack Mode Parameters

    0 = Straight

    1 = Combination

    2 = Toggle-Case

    3 = Brute-force

    4 = Permutation

    5 = Table-Lookup

    8 = Prince

##### Built-In charsets

   ?l = abcdefghijklmnopqrstuvwxyz

   ?u = ABCDEFGHIJKLMNOPQRSTUVWXYZ

   ?d = 0123456789

   ?s =  !"#$%&'()*+,-./:;<=>?@[\]^_`{|}~

   ?a = ?l?u?d?s

   ?b = 0x00 - 0xff

##### hashcat Dictionary Attack 

using a wordlist such as, 

**rockyou.txt WordList**:
https://www.scrapmaker.com/data/wordlists/dictionaries/rockyou.txt

**hashcat -m 0 -a 0 -o cracked.txt target_hashes.txt /usr/share/wordlists/rockyou.txt**

The command above is for the MD5 hash, by using the **-m 0** to designate

##### hashcat Combinator Attack 

Since people are ingrained to create password of two words mushed together, using the combinator Attack creates a new word list of every word combined with the other. 

First you create your combined wordlist 

This is a wordlist of 1000 most common words in english: https://gist.github.com/deekayen/4148741

This is a dictionary of txt files with the worst passwords:
https://wiki.skullsecurity.org/Passwords


**/usr/share/hashcat-utils/combinator.bin 500-worst-passwords.txt 1-1000.txt > combined_wordlist.txt** # merge wordlists 

hashcat -m 0 bfield.hash combined_wordlist.txt

The command above runs the attack of the merged wordlist

##### hashcat Mask Attack 

Since most users use the format like "Bananas1", hashcat lets you configure it to search for all the passwords in that format.

**hashcat -m 0 -a 3 -1 ?u -2 -?l?u?d -3 ?d  hash ?1?2?2?2?3?3?3** # using a format of "Mask101"

// **hash ?1?2?2?2?3?3?3** is the actual format of the hash 

##### hashcat Rule Based Attack 

Dubbed the "...most complicated of all the attack modes" by hellcat themselves, the rule based attack acts like a programming language for password attacking. It's functions allow the attacker to modify, cut, or extend words and has conditional operators.  

Reference for the expressions: https://hashcat.net/wiki/doku.php?id=rule_based_attack

### chntpw

This tool is used to edit the windows refistry

1. reset a users password
2. promote user to admin

**chntpw [OPTIONS] <samfile> [systemfile] [securityfile] [otherreghive]** # syntax 

### ophcrack-cli

It's a Microsoft Windows password cracker that uses rainbow tables as it's preferred method.

The rainbow tables can be found here: 
https://ophcrack.sourceforge.io/tables.php

When using ophcrack-cli make sure that pwdump6 and fgdump are installed to recieve compatible output.

**ophcrack-cli -g -d path_to_rainbow_tables_dir/ -t path_to_rainbow_tables_dir/ -n 4 -f hashes.txt**

**-d** - Path to rainbow tables
**-g** - do no run the GUI interface
**-t** - specify which table to use. 
**-n** - number of threads to use
**-f** - path to hashes file obtained from programs like fgdump or pwdump

### samdump2

This tool dumps the Window NT/2k/XP/Vista password hashes. It pulls them from the Security Account Manager (SAM) database. Since windows uses SysKey to encrypt their SAM database.  samdump2 pulls the key, decrypts and reveals the password hashes. 

**samdump2 SYSTEM SAM > hashes.txt** #syntax

### John the Ripper

Good ol' john is an open source password auditor and recovery tool. It supports hundreds of hash and cipher types. Essentially if you can think of one john probably supports it. 

First a copy of the password file needs to be made. 
For Windows: 

Dump the password hashes with samdump2

For Linux: 

**umask 077
unshadow /etc/passwd /etc/shadow > mypasswd**

**Make sure to make *mypasswd* available to non-root user accounts as well** 

Next let john do it's magic:

**john mypasswd**

The command above runs on the default john file, but the script could be modified to use another wordlist file by assigning it to the variable:

**Wordlist=...***  to obtain a larger range.

Wordlists: https://www.openwall.com/wordlists/

## Online Password Attacks 

When an attacker attempts to attack a computer sustem through an interface that is also presented to legitimate users, its an Online Password attack. Online password attacks support mainly dictionary attacks and brute force attacks. 


Advantages:

1. there is no need for special privileges to initiate the attack. 
2. wider variety of protocols that can be attacked
    - any one that accepts a login and password
3. can be initiated from anywhere in the world over the internet 


Disadvantages: 

1. It all depends on network spees and built-in delays making it slow
2. Noisy. Network services have log files that keep track of the login attempts
    - IDS/IPS and a web application firewall can be thanked for that
3. can be stopped after a certain amount of login attempts 

### hydra / hydra-gtk

It brute forces login information for services like, 

1. ftp
2. ssh
3. telnet
4. MS-SQL 

**hydra -l <\USER\> -p <\Password\> <\IP Address\> http-post-form “<\Login Page>:<\Request Body\>:<\Error Message\>”**

You can get the information for the hydra syntax by entering the html through 'inspect element'. 

Steps: 

1. Go to headers area 
2. Go to Network tab and then make an attempt to login
3. After the fail, click on the POST method 
4. Click on "Edit and Resent" 
5. Grab the Hostname/IP , Login Page, Request body, and the Error message
6. Build the command with that. 

### onesixtyone 

In the SNMP database,MIB, companies have the option of using either the secure SNMPv3 vs the insecure SNMPv1. Since many companies use the latter, the community public string password that provide the access to that SNMP is fair game for hacking. Once cracked the attacker has availability to all the information in the SNMP MIB. THe attacker can also attempt to gain access to the private community string which then allows them to configure settings on the router or switch and change any settings on any network device. 

onesixtyone allows all of this to happen. 

**onesixtyone -c dixt.txt <\IP address\>**

The command above uses a built in wordlist, but if another wordlist is desired a full path to it is needed. 

### patator 

Like hydra, patator brute forces login information such as,

1. ftp
2. ssh
3. Telnet
4. smtp 
5. HTTP
6. POP3
7. poppasswd 
8. IMAP4 
9. SMB 
10. LDAP

The key to using patator is by using the scrambled username and password grabbed in burp. 

#### Breaking into router gateways with patator 

The general outline to gaining access to gaining authentication to router gateways using patator is the following,

1. Capture the login request 
    - use burp
    
2. Identify the parameters
    - the username and password 

3. Modify and save the request
    - insert placeholder to help patator iterate through the desired wordlist
    
4. Generate the targeted wordlist 
    
5. Identify and Filter failed requests
  

##### Capture the Login Request 

Start up the configured burp firefox, and begin a failed login request using "admin" and "password" as your parameters. 
burp will then intercept the login request and display it. 

##### Identify the Parameters

When looking at the intercepted burp request, it will show that the password is a random string. Let's use the site, https://null-byte.wonderhowto.com/how-to/break-into-router-gateways-with-patator-0194600/, example "5f4dcc3b5aa765d61d8327deb882cf99" 

THe username and password should look like this in the script:

**username=admin&password=5f4dcc3b5aa765d61d8327deb882cf99**

The type of hash is then identified as MD5, meaning we can then use an MD5 wordlist. 

##### Modify and Save the Raw Request

In the raw section of the intercepted request in burp, change the password variable from "5f4dcc3b5aa765d61d8327deb882cf99" tp "File0".


**username=admin&password=File0**

This is a placeholder for patator to know where to insert the wordlist passwords. 

Inside the burp window copy the file with a right click and save ii in the tmp folder as "router_request.txt" to make it understandable. 

**/tmp/router_request.txt**

##### Generate a Wordlist

A wordlist just needs to be used. A while loop can be used to convert any wordlist in to a MD5 hash wordlist. 

**file read password; do printf "$password" | md5sum | awk '{print $1}'; done < /tmp/wordlist.txt >>/tmp/md5_wordlist.tx**

##### Identify and Filter the Failed Requests

**patator http_fuzz raw_request=router_request.txt -x ignore:size=20 accept_cookie=1 follow=1 0=/tmp/md5_wordlist.txt -l /tmp/AC1200**

To break down the command above: 

1. **raw_request=**
    - Use the router_request.txt created in an earlier step to generate login attempts against the router's gateway.

2. **accept_cookie=**
    - Save received cookies to issue them in future requests.
    
3. **follow=**
    - Follow Location redirects (e.g., status code 302), for both failed and successful login attempts if instructed by the server.

4. **0=**
    - The "FILE0" placeholder in the router_request.txt will iterate through the provided list of passwords.

5. **-l**
    - Save output data into the provided directory. 
    
6. **-x ignore:size=20** 
    - Omits responses that could be a failed login attempt since it is safe to assume that successful ones aren't that size. 

After the hash is displayed, the unhashing process begins. 

**nl /tmp/md5_wordlist.txt | grep '<\hash number\>'**

In the command above, the **nl** command is used to prepend a number to every line in the wordlist created then **grep**ed for the hash. 

**nl /tmp/wordlist.txt | grep '<\line number\>'**

The password should be displayed. It can then be verified by the command below: 

**printf '<\outputed password\>' | md5sum** # shows the md5 for the outputed password

## Passing the Hash Tools 

The biggest problem encountered when using password attacks is the amount of time it takes. For this reason, pass-the-hash-attacks were invented. It eliminates the ability to crack a password by bypassing it using a hash directly. It's a more complicated and meticulous techinque which is why it's so rare to know about it. The password hashes are loaded into the Local Security Authority Subsystem (Lsass) and runs as the executable:

**%SystemRoot%\System32\Lsass.exe**

To fully understand, these two questions need to be asked; 

1. How are passwords stored? 
2. How are they used? 

#### How are Passwords Stored? 

As previously mentioned, passwords use the hashing function. The Windows operating system useds five ways to store passwords, 

1. LM Hash 
2. NTLM Hash
3. Cached Credentials 
4. Memory 
5. Reversibly Encrypted 

##### LM Hash 

This hash is used as the default in earlier versions of Windows. Newer versions use NTLMv2.

The creation of a new password follows these steps; 

1. The user's new password is converted to all uppercase  and "padded out", fills in unused portions of a data structure, into 14 characters. 

2. The password is split into 7-byte chunks 

3. The two chunks are used as a key in the Data Encryption Standard (DES) to encrypt into a fixed value

4. The two values of the two DES operations are then concatenated and is stored as the LM Hash. 

Weaknesses: 

1. The password length is limited to 14 characters 
2. Password is case-insensitive 

##### NTLM Hash 

The NTLM Hash uses the MD4 algorithm, which takes a message and outputs a 128-bit hash, then proceeds to store it. No chunks necessary, is case sensitive, and supports long passwords. 

Weaknesses:

1. If two hex digits are the same, it can help fortify a collision attack

Full Abstract of the MD4 Algorithm: https://link.springer.com/content/pdf/10.1007/3-540-38424-3_22.pdf

##### Cached Credentials 

This process refers to the storing of domain login credentials that are accessible without the need for the domain member to be connected to the domain controller. These credentials are stored in the SAM as previously mentioned. 

##### Memory 

Whenever a user logs on Windows caches the hashed in a memory location only accessible by the operating system or any process acting as the operating system. This helps the operating use user authentication without the user having to verify themselves every two seconds. The location is then purged when the user locks the system or logs off.

##### Reversibly Encrypted

Passwords can be encrypted in a way that allows it to be reversed and the clear text fully revealed. This storage is mainly disabled by default. 

#### How are Passwords Used? 

##### LM and NTLM 

Used for; 

1. Authentication in workgroups
2. If the client or server is not a domain member
3. A resource within a domain is accessed by its IP address instead of NetBIOS or DNS


##### NTLMv2

Uses the NT Hash, but includes timestamps and client challenge. Meaning it verfies the the client by sending tw 8 byte challenges to the server. The hash is not stored in Windows and is randomly generated right then and there. 

##### Kerberos

Is used when a NetBIOS or DNS name is used to connect. Provides authentication for both client and server, in which they agree on the encryption algorithm, share a secret key, and the authenticator that includes;

1. Sender's name
2. domain 
3. time
4. IP 
5. MD5 checksum 

### mimikatz

This tool allows you to view and save authentication credentials such as Kerberos Tickets and can be used to escalate privileges. After dropping into the system's shell, having administrator privileges, run mimikatz and use the command,

**privilege::debug** # used to debug privileges

**sekurlsa::logonPassword** # dumps the credentials data/user's hashes

Hashcat can then be used to crack it. 

Use the two overviews on how to use mimikatz more in depth: 

**Part 1**: https://www.praetorian.com/blog/inside-mimikatz-part1
**Part 2**: https://www.praetorian.com/blog/inside-mimikatz-part2

## Password Profiling 

When password profiling getting a smaller wordlist is the main goal. This can be achieved by gathering information against the target machine and business. 

### cewl 

This RUBY application creates custom word lists through spidering a target's wrbsite and collecting particular words. 

**cewl <\http url\> - w dict.txt** 

The command above is pretty standard, cewls a website then **-w** saves the output into the text file dict.txt. 

### crunch

This tool creates wordlists from scratch. 

**crunch 1 3 0123456789 > wordlist.txt**

The command above creates a list of every possible combination of the numbers zero through 9  with one ,two, and three characters. 

**crunch 3 5 0123456789abcdefghijklmnopqrstuvwxyz**

The command above creates a list all possible three,four, and five character combinations of the numbers 0-9 and the alphabet using lowercasecharacters.
